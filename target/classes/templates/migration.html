<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>ğŸ“¦ DB ë§ˆì´ê·¸ë ˆì´ì…˜</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { 
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; 
            background: #f5f5f5; 
            padding: 20px; 
        }
        .container { max-width: 1200px; margin: 0 auto; background: white; padding: 30px; border-radius: 8px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
        h1 { color: #333; margin-bottom: 30px; }
        .stats-grid { 
            display: grid; 
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); 
            gap: 20px; 
            margin-bottom: 30px; 
        }
        .stat-card { background: #f9f9f9; padding: 20px; border-radius: 6px; text-align: center; border-left: 4px solid #4CAF50; }
        .stat-card h3 { font-size: 14px; color: #666; margin-bottom: 10px; }
        .stat-card .value { font-size: 32px; font-weight: bold; color: #333; }
        .button-group { display: flex; gap: 10px; margin-bottom: 20px; flex-wrap: wrap; }
        button { 
            padding: 12px 24px; 
            border: none; 
            border-radius: 6px; 
            cursor: pointer; 
            font-size: 14px; 
            font-weight: 600; 
            transition: all 0.3s; 
        }
        .btn-primary { background: #4CAF50; color: white; }
        .btn-primary:hover { background: #45a049; }
        .btn-warning { background: #ff9800; color: white; }
        .btn-warning:hover { background: #e68900; }
        .btn-danger { background: #f44336; color: white; }
        .btn-danger:hover { background: #da190b; }
        .btn-secondary { background: #2196F3; color: white; }
        .btn-secondary:hover { background: #0b7dda; }
        #log { 
            background: #1e1e1e; 
            color: #d4d4d4; 
            padding: 20px; 
            border-radius: 6px; 
            height: 400px; 
            overflow-y: auto; 
            font-family: 'Courier New', monospace; 
            font-size: 13px; 
            line-height: 1.6; 
        }
        .log-success { color: #4CAF50; }
        .log-error { color: #f44336; }
        .log-warning { color: #ff9800; }
        .log-info { color: #2196F3; }
        .progress-bar {
            width: 100%;
            height: 30px;
            background: #f0f0f0;
            border-radius: 15px;
            overflow: hidden;
            margin: 20px 0;
            display: none;
        }
        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #4CAF50, #45a049);
            width: 0%;
            transition: width 0.3s;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: bold;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸ“¦ txt â†’ Oracle DB ë§ˆì´ê·¸ë ˆì´ì…˜</h1>
        
        <!-- í†µê³„ -->
        <div class="stats-grid">
            <div class="stat-card">
                <h3>í…ŒìŠ¤íŠ¸ ì¼€ì´ìŠ¤</h3>
                <div class="value" th:text="${stats.totalCases}">0</div>
            </div>
            <div class="stat-card">
                <h3>ì‹œë‚˜ë¦¬ì˜¤</h3>
                <div class="value" th:text="${stats.totalScenarios}">0</div>
            </div>
            <div class="stat-card">
                <h3>ìŠ¤í…</h3>
                <div class="value" th:text="${stats.totalSteps}">0</div>
            </div>
            <div class="stat-card">
                <h3>í‰ê·  ìŠ¤í…/ì¼€ì´ìŠ¤</h3>
                <div class="value" th:text="${stats.avgStepsPerCase}">0</div>
            </div>
        </div>
        
        <!-- ë²„íŠ¼ -->
        <div class="button-group">
            <button class="btn-primary" onclick="migrateAll()">
                ğŸš€ ì „ì²´ ë§ˆì´ê·¸ë ˆì´ì…˜
            </button>
            <button class="btn-secondary" onclick="refreshStats()">
                ğŸ”„ í†µê³„ ìƒˆë¡œê³ ì¹¨
            </button>
            <button class="btn-warning" onclick="showFileInput()">
                ğŸ“„ ë‹¨ì¼ íŒŒì¼ ë§ˆì´ê·¸ë ˆì´ì…˜
            </button>
            <button class="btn-danger" onclick="confirmDeleteAll()">
                ğŸ—‘ï¸ ì „ì²´ ë°ì´í„° ì‚­ì œ
            </button>
            <a href="/cases" style="text-decoration:none;">
                <button class="btn-secondary">â† í…ŒìŠ¤íŠ¸ ì¼€ì´ìŠ¤ ëª©ë¡</button>
            </a>
        </div>
        
        <!-- ì§„í–‰ë¥  -->
        <div class="progress-bar" id="progressBar">
            <div class="progress-fill" id="progressFill">0%</div>
        </div>
        
        <!-- ë¡œê·¸ -->
        <div id="log">
            <span class="log-info">ğŸ’¡ ë§ˆì´ê·¸ë ˆì´ì…˜ ì¤€ë¹„ ì™„ë£Œ</span><br>
            <span class="log-info">ğŸ“‚ output ë””ë ‰í† ë¦¬ì˜ test_case_*.txt íŒŒì¼ì„ DBë¡œ ì´ê´€í•©ë‹ˆë‹¤.</span><br>
            <span class="log-warning">âš ï¸ ì£¼ì˜: ì¤‘ë³µ íŒŒì¼ì€ ìë™ìœ¼ë¡œ ìŠ¤í‚µë©ë‹ˆë‹¤.</span><br>
        </div>
    </div>
    
    <script>
        function log(message, type = 'info') {
            const logEl = document.getElementById('log');
            const timestamp = new Date().toLocaleTimeString();
            const colorClass = `log-${type}`;
            logEl.innerHTML += `<span class="${colorClass}">[${timestamp}] ${message}</span><br>`;
            logEl.scrollTop = logEl.scrollHeight;
        }
        
        async function migrateAll() {
            if (!confirm('ì „ì²´ txt íŒŒì¼ì„ DBë¡œ ë§ˆì´ê·¸ë ˆì´ì…˜í•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) return;
            
            log('ğŸš€ ì „ì²´ ë§ˆì´ê·¸ë ˆì´ì…˜ ì‹œì‘...', 'info');
            document.getElementById('progressBar').style.display = 'block';
            
            try {
                const response = await fetch('/migration/all', { method: 'POST' });
                const result = await response.json();
                
                if (result.success) {
                    log(`âœ… ì„±ê³µ: ${result.successCount}ê°œ, ì‹¤íŒ¨: ${result.failedCount}ê°œ`, 'success');
                    
                    // ìƒì„¸ ê²°ê³¼ ì¶œë ¥
                    for (const [file, status] of Object.entries(result.details)) {
                        if (status === 'SUCCESS') {
                            log(`  âœ“ ${file}`, 'success');
                        } else {
                            log(`  âœ— ${file} - ${status}`, 'error');
                        }
                    }
                    
                    setTimeout(refreshStats, 1000);
                } else {
                    log(`âŒ ${result.message}`, 'error');
                }
            } catch (error) {
                log(`âŒ ì—ëŸ¬: ${error.message}`, 'error');
            } finally {
                document.getElementById('progressBar').style.display = 'none';
            }
        }
        
        async function refreshStats() {
            log('ğŸ”„ í†µê³„ ìƒˆë¡œê³ ì¹¨...', 'info');
            try {
                const response = await fetch('/migration/stats');
                const stats = await response.json();
                
                document.querySelector('.stats-grid').innerHTML = `
                    <div class="stat-card">
                        <h3>í…ŒìŠ¤íŠ¸ ì¼€ì´ìŠ¤</h3>
                        <div class="value">${stats.totalCases}</div>
                    </div>
                    <div class="stat-card">
                        <h3>ì‹œë‚˜ë¦¬ì˜¤</h3>
                        <div class="value">${stats.totalScenarios}</div>
                    </div>
                    <div class="stat-card">
                        <h3>ìŠ¤í…</h3>
                        <div class="value">${stats.totalSteps}</div>
                    </div>
                    <div class="stat-card">
                        <h3>í‰ê·  ìŠ¤í…/ì¼€ì´ìŠ¤</h3>
                        <div class="value">${stats.avgStepsPerCase}</div>
                    </div>
                `;
                
                log('âœ… í†µê³„ ì—…ë°ì´íŠ¸ ì™„ë£Œ', 'success');
            } catch (error) {
                log(`âŒ ${error.message}`, 'error');
            }
        }
        
        function showFileInput() {
            const fileName = prompt('ë§ˆì´ê·¸ë ˆì´ì…˜í•  íŒŒì¼ëª…ì„ ì…ë ¥í•˜ì„¸ìš” (ì˜ˆ: test_case_1.txt)');
            if (fileName) {
                migrateSingleFile(fileName);
            }
        }
        
        async function migrateSingleFile(fileName) {
            log(`ğŸš€ íŒŒì¼ ë§ˆì´ê·¸ë ˆì´ì…˜ ì‹œì‘: ${fileName}`, 'info');
            
            try {
                const response = await fetch(`/migration/single?fileName=${fileName}`, { 
                    method: 'POST' 
                });
                const result = await response.json();
                
                if (result.success) {
                    log(`âœ… ${result.message}`, 'success');
                    setTimeout(refreshStats, 1000);
                } else {
                    log(`âŒ ${result.message}`, 'error');
                }
            } catch (error) {
                log(`âŒ ì—ëŸ¬: ${error.message}`, 'error');
            }
        }
        
        async function confirmDeleteAll() {
            const confirm1 = confirm('âš ï¸ ê²½ê³ : ëª¨ë“  ë°ì´í„°ê°€ ì‚­ì œë©ë‹ˆë‹¤!');
            if (!confirm1) return;
            
            const confirm2 = confirm('âš ï¸ ì •ë§ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ? (ë˜ëŒë¦´ ìˆ˜ ì—†ìŠµë‹ˆë‹¤)');
            if (!confirm2) return;
            
            log('ğŸ—‘ï¸ ì „ì²´ ë°ì´í„° ì‚­ì œ ì¤‘...', 'warning');
            
            try {
                const response = await fetch('/migration/all', { method: 'DELETE' });
                const result = await response.json();
                
                if (result.success) {
                    log('âœ… ì „ì²´ ë°ì´í„° ì‚­ì œ ì™„ë£Œ', 'success');
                    setTimeout(refreshStats, 1000);
                } else {
                    log(`âŒ ${result.message}`, 'error');
                }
            } catch (error) {
                log(`âŒ ì—ëŸ¬: ${error.message}`, 'error');
            }
        }
    </script>
</body>
</html>
